<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback | FloodWatch</title>
  <!-- Ionicons for icons -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <!-- Google Translate -->
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'es,fr,de,zh-CN,ja,ru,ar',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <style>
    :root {
      --fw-blue: #0056b3;
      --fw-blue-dark: #004494;
      --fw-grey: grey;
      --fw-red: #c00;
      --fw-bg: #f4f6f8;
      --fw-font: 'Roboto', sans-serif;
    }
    body {
      font-family: var(--fw-font);
      background: var(--fw-bg);
      margin: 0;
      padding: 0;
      color: #333;
    }
    .feedback-container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .feedback-container h2 {
      color: var(--fw-blue);
      margin-bottom: 24px;
      font-size: 1.75rem;
    }
    #google_translate_element {
      margin-bottom: 20px;
    }
    .feedback-container label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .feedback-container select,
    .feedback-container input[type="tel"],
    .feedback-container textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 1rem;
      resize: vertical;
    }
    .feedback-container input[type="submit"] {
      background: var(--fw-blue);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 12px 24px;
      font-size: 1rem;
      cursor: pointer;
    }
    .feedback-container input[type="submit"]:hover {
      background: var(--fw-blue-dark);
    }
    fieldset {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }
    legend {
      font-weight: 600;
    }
    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .radio-group label {
      font-weight: normal;
    }
    /* Audio record buttons */
    #record-btn,
    #stop-btn {
      background: var(--fw-blue);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #record-btn:hover,
    #stop-btn:not([disabled]):hover {
      background: var(--fw-blue-dark);
    }
    #stop-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #record-btn img,
    #stop-btn ion-icon {
      width: 24px;
      height: 24px;
      color: #fff;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
      70%  { box-shadow: 0 0 0 12px rgba(255,0,0,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
    }
    #record-btn.recording {
      background: var(--fw-grey);
      animation: pulse 1s infinite;
    }
    #stop-btn.recording {
      background: red;
    }
    #audio-feedback div.player-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }
    #delete-btn {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      line-height: 1;
      color: var(--fw-red);
      cursor: pointer;
      display: none;
      padding: 0;
    }
    ion-icon {
      font-size: 24px;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="feedback-container">
    <h2>We Value Your Feedback!</h2>
    <div id="google_translate_element"></div>
    <form id="feedback-form">
      <label for="navigate">1. How easy was it to navigate the website?</label>
      <select id="navigate" name="navigate" required>
        <option value="" disabled selected>Select one</option>
        <option>Very easy</option>
        <option>Easy</option>
        <option>Neutral</option>
        <option>Difficult</option>
        <option>Very difficult</option>
      </select>
      <label for="design-rate">2. Rate the overall design and layout <small>(1 = Poor, 5 = Excellent)</small></label>
      <select id="design-rate" name="design_rate" required>
        <option value="" disabled selected>Select one</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <fieldset>
        <legend>3. Did you encounter any technical issues?</legend>
        <div class="radio-group">
          <label><input type="radio" name="issues" value="No issues" required> No issues</label>
          <label><input type="radio" name="issues" value="Minor issues"> Minor issues</label>
          <label><input type="radio" name="issues" value="Major issues"> Major issues</label>
          <label><input type="radio" name="issues" value="Didn’t use fully"> I didn’t use fully</label>
        </div>
      </fieldset>
      <label for="overall">4. Describe your overall experience:</label>
      <textarea id="overall" name="overall_experience" rows="3"></textarea>
      <label for="relevance">5. How relevant did you find the content? <small>(1 = Not relevant, 5 = Very relevant)</small></label>
      <select id="relevance" name="relevance" required>
        <option value="" disabled selected>Select one</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <fieldset>
        <legend>6. Was the information clear and understandable?</legend>
        <div class="radio-group">
          <label><input type="radio" name="clear" value="Yes" required> Yes</label>
          <label><input type="radio" name="clear" value="Somewhat"> Somewhat</label>
          <label><input type="radio" name="clear" value="No"> No</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>7. Did the FlowBot solution seem practical?</legend>
        <div class="radio-group">
          <label><input type="radio" name="practical" value="Yes" required> Yes</label>
          <label><input type="radio" name="practical" value="No"> No</label>
          <label><input type="radio" name="practical" value="Not sure"> Not sure</label>
        </div>
      </fieldset>
      <label for="interesting">8. What part did you find most interesting or impactful?</label>
      <textarea id="interesting" name="interesting_part" rows="3"></textarea>
      <label for="improvements">9. Any suggestions to improve the website?</label>
      <textarea id="improvements" name="improvements" rows="3"></textarea>
      <fieldset>
        <legend>10. Would you recommend this site to others?</legend>
        <div class="radio-group">
          <label><input type="radio" name="recommend" value="Yes" required> Yes</label>
          <label><input type="radio" name="recommend" value="No"> No</label>
          <label><input type="radio" name="recommend" value="Maybe"> Maybe</label>
        </div>
      </fieldset>
      <div id="audio-feedback">
        <label>Describe experience (or record your voice):</label><br>
        <button type="button" id="record-btn" aria-label="Start recording"><img src="media/seo-social-web-network-internet_09_icon-icons.com_61507.png" alt="Record"></button>
        <button type="button" id="stop-btn" aria-label="Stop recording" disabled><ion-icon name="stop-circle-outline"></ion-icon></button>
        <div class="player-container">
          <audio id="player" controls style="display:none;"></audio>
          <button type="button" id="delete-btn" aria-label="Delete recording">×</button>
        </div>
        <input type="hidden" name="audio_blob" id="audio-blob">
      </div>
      <label for="phone">11. Phone number (optional):</label>
      <input type="tel" id="phone" name="phone" placeholder="+221 77 123 45 67">
      <input type="submit" value="Submit Feedback">
    </form>
    <iframe name="hidden_iframe" style="display:none;"></iframe>
  </div>
  <script>
    // Restore saved values
    window.addEventListener('DOMContentLoaded', () => {
      ['navigate','design_rate','issues','overall_experience',
       'relevance','clear','practical','interesting_part',
       'improvements','recommend','audio-blob','phone'].forEach(id => {
        const el = document.getElementById(id);
        const val = localStorage.getItem(id);
        if (el && val) el.value = val;
      });
    });
    // Elements
    const form = document.getElementById('feedback-form');
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const player = document.getElementById('player');
    const blobInput = document.getElementById('audio-blob');
    const deleteBtn = document.getElementById('delete-btn');
    let recorder, chunks = [];
    // Form submit
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);

        try {
            const res = await fetch('https://script.google.com/macros/s/AKfycby-GWlk48IxrMc3yvvIrQANuaoSQWozsDNjpBowjMhb2aEKNtIakNsWRnQ4MSb7VrEt/exec', {
            method: 'POST',
            body: formData
            });

            // Try to parse JSON; if it fails, fall back to text
            let result;
            try {
            result = await res.json();
            } catch(parseErr) {
            const txt = await res.text();
            // if your script ever returns HTML like "<p>Thanks…", detect it:
            if (txt.includes('Thanks')) {
                result = { success: true };
            } else {
                throw parseErr;
            }
            }

            if (result.success) {
            localStorage.clear();
            window.location.href = '/FloodW/';
            } else {
            alert(result.message || 'Submission error');
            }
        } catch (err) {
            console.error('Submission error:', err);
            window.location.href = '/FloodW/';
        
        }
        });



    // Recording
    recordBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          chunks = [];
          player.src = URL.createObjectURL(blob);
          player.style.display = 'block';
          deleteBtn.style.display = 'inline-block';
          const reader = new FileReader();
          reader.onload = () => blobInput.value = reader.result;
          reader.readAsDataURL(blob);
          // stop all tracks
          stream.getTracks().forEach(t => t.stop());
        };
        recorder.start();
        recordBtn.classList.add('recording');
        stopBtn.classList.add('recording');
        recordBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error('Mic error:', err);
        alert('Microphone access denied.');
      }
    });
    stopBtn.addEventListener('click', () => {
      recorder.stop();
      recordBtn.classList.remove('recording');
      stopBtn.classList.remove('recording');
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    });
    deleteBtn.addEventListener('click', () => {
      player.src = '';
      player.style.display = 'none';
      blobInput.value = '';
      deleteBtn.style.display = 'none';
    });
  </script>
</body>
</html>
